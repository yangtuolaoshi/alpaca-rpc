### 整体架构

![项目架构](https://github.com/yangtuolaoshi/alpaca-rpc/assets/165141531/8c010d46-26a7-4031-8c22-f882b96298b6)

### 自定义协议

一般情况下，RPC框架更注重性能，而HTTP协议所携带的头部信息较多，影响网络传输效率。因此本项目自定义了一套网络传输协议来实现更高性能的RPC框架。

为了提升逼格，自定义的网络传输协议命名为**AlpacaProtocol**。该协议基于TCP协议实现，属于应用层协议。协议数据报的格式如下



首部长度17字节，包含以下内容

* **魔数**：安全校验，防止处理乱七八糟的信息，类似于HTTPS的安全证书 8b
* **版本号**：保证请求和响应一致性 8b
* **序列化方式**：类似于HTTP协议中的content-type 8b
* **类型**：这一则消息是请求还是响应还是心跳检测等其它内容 8b
* **状态**：如果是响应，记录响应的`code`，比如HTTP的`200`就是成功 8b
* **请求ID**：TCP是双向通信，需要唯一标识来追踪每个请求 64b
* **数据长度**：请求体的长度 32b

### SPI机制

AlpacaRPC提供了SPI机制，能够让开发者像添加插件一样添加自定义的接口实现，包括序列化器、注册中心、负载均衡器、重试机制等都可以通过SPI机制插件化扩展。

### 请求与响应

为了简化服务消费者远程调用的操作，AlpacaProtocol使用代理工厂创建接口代理对象，用户仅需要**一行代码**就可以拿到代理对象并调用接口。

同时，AlpacaProtocol也为服务提供者提供了请求处理器，服务提供者只需要将自己提供的远程调用服务注册到**本地注册器**，请求处理器可以自动处理请求并调用对应接口。

### 注册中心

AlpacaRPC使用**云原生中间件Etcd**作为高可用的分布式注册中心，并通过定时任务实现**心跳检测**，以保证注册信息的一致性。同时也支持用户通过SPI机制插件化扩展自己的注册中心实现。

### 负载均衡

为增强服务集群处理能力，AlpacaRPC提供了**轮询**、**随机**、**一致性哈希**等负载均衡算法。同时也支持用户通过SPI机制插件化扩展自己的负载均衡器实现。

### 重试机制

为了提升系统稳定性，AlpacaRPC提供了包括**不重试**、**固定间隔重试**等多种重试方案。同时也支持用户通过SPI机制插件化扩展自己的重试机制实现。

